<h2>XMLHttpRequest</h2>

<ul class="list-point">
	<li>XMLHttpRequest («XHR») дает возможность из JavaScript делать HTTP-запросы к серверу без перезагрузки страницы</li>
	<li>Ответы на запросы XMLHttpRequest кешируются, как и обычные страницы</li>
</ul>

<!------------------------------------------------------>
<h3>Методы</h3>
<!------------------------------------------------------>
<pre><code class="js light">
<bg-methods>xhr.open</bg-methods><bg-arguments>(method, URL, async, user, password)</bg-arguments> // вызов open не открывает соединение. Он лишь настраивает запрос, а коммуникация инициируется методом send
	<em>&#8226; method</em>      // HTTP-метод. GET / POST / TRACE / DELETE / PUT и т.д.
	<em>&#8226; URL</em>         // адрес запроса. Можно использовать не только http/https, но и другие протоколы, например ftp:// и file://. При этом есть ограничения безопасности, называемые «Same Origin Policy»: запрос со страницы можно отправлять только на тот же протокол://домен:порт
	<em>&#8226; async</em>       // если установлено в false, то запрос производится синхронно, если true – асинхронно
	<em>&#8226; user</em>        // логин для HTTP-авторизации, если нужны
	<em>&#8226; password</em>    // пароль для HTTP-авторизации, если нужны
<bg-methods>xhr.send</bg-methods><bg-arguments>([body])</bg-arguments> // метод открывает соединение и отправляет запрос на сервер
	<em>&#8226; body</em>        // тело запроса
<bg-methods>xhr.abort</bg-methods><bg-arguments>()</bg-arguments>     // прерывает выполнение запроса
<bg-methods>setRequestHeader</bg-methods><bg-arguments>(name, value)</bg-arguments> // устанавливает заголовок name запроса со значением value. Отменить setRequestHeader невозможно
	<em>&#8226; name</em>  // 'Content-Type'
	<em>&#8226; value</em> // 'application/json'
<bg-methods>getResponseHeader</bg-methods><bg-arguments>(name)</bg-arguments> // возвращает значение заголовка ответа name, кроме Set-Cookie и Set-Cookie2
	<em>&#8226; name</em>  // 'Content-Type'
<bg-methods>getAllResponseHeaders</bg-methods><bg-arguments>()</bg-arguments> // возвращает все заголовки ответа, кроме Set-Cookie и Set-Cookie2. Заголовки возвращаются в виде единой строки. Между заголовками стоит перевод строки в два символа "\r\n" (не зависит от ОС), значение заголовка отделено двоеточием с пробелом ": "
	// Cache-Control: max-age=31536000
	// Content-Length: 4260
	// Content-Type: image/png
	// Date: Sat, 08 Sep 2012 16:53:16 GMT
</code></pre>

<!------------------------------------------------------>
<h3>Свойства XMLHttpRequest</h3>
<!------------------------------------------------------>
<pre><code class="js light">
<em>&#8226; xhr.status</em>       // HTTP-код ответа: 200, 404, 403 и так далее. Может быть также равен 0, если сервер не ответил или при запросе на другой домен
<em>&#8226; xhr.statusText</em>   // Текстовое описание статуса от сервера: OK, Not Found, Forbidden и т.д.
<em>&#8226; xhr.responseText</em> // Текст ответа сервера. Для json JSON.parse(xhr.responseText)
<em>&#8226; xhr.responseXML</em>  // Если сервер вернул XML, снабдив его правильным заголовком Content-type: text/xml, то браузер создаст из него XML-документ. По нему можно будет делать запросы xhr.responseXml.querySelector("...") и другие
<em>&#8226; xhr.timeout</em>      // Максимальная продолжительность асинхронного запроса. При превышении этого времени запрос будет оборван и сгенерировано событие ontimeout
</code></pre>

<pre><code class="js">
xhr.timeout = 30000; // 30 секунд (в миллисекундах)
xhr.ontimeout = function() {
	alert( 'Извините, запрос превысил максимальное время' );
}
</code></pre>

<!------------------------------------------------------>
<h3>События</h3>
<!------------------------------------------------------>
<pre><code class="js light">
<em>&#8226; onreadystatechange</em> // можно посмотреть «текущее состояние запроса» в свойстве xhr.readyState
<em>&#8226; onloadstart</em>        // запрос начат
<em>&#8226; onprogress</em>         // браузер получил очередной пакет данных, можно прочитать текущие полученные данные в responseText
<em>&#8226; onabort</em>            // запрос был отменён вызовом xhr.abort()
<em>&#8226; onerror</em>            // произошла ошибка
<em>&#8226; onload</em>             // запрос был успешно (без ошибок) завершён
<em>&#8226; ontimeout</em>          // запрос был прекращён по таймауту
<em>&#8226; onloadend</em>          // запрос был завершён (успешно или неуспешно)
</code></pre>

<!------------------------------------------------------>
<h3>Свойство xhr.readyState для текущего состояния запроса</h3>
<!------------------------------------------------------>
<ul class="list-point">
	<li>Событие readystatechange происходит несколько раз в процессе отсылки и получения ответа. При этом можно посмотреть «текущее состояние запроса» в свойстве xhr.readyState</li>
	<li>Запрос проходит их в порядке 0 → 1 → 2 → 3 → … → 3 → 4, состояние 3 повторяется при каждом получении очередного пакета данных по сети</li>
</ul>

<pre><code class="js light">
const unsigned short UNSENT           = 0; // начальное состояние
const unsigned short OPENED           = 1; // вызван open
const unsigned short HEADERS_RECEIVED = 2; // получены заголовки
const unsigned short LOADING          = 3; // загружается тело (получен очередной пакет данных)
const unsigned short DONE             = 4; // запрос завершён
</code></pre>
<!------------------------------------------------------>
<h3>Асинхронный</h3>
<!------------------------------------------------------>
<pre><code class="js">
var xhr = new XMLHttpRequest();
xhr.open('GET', 'script.php', true);
xhr.send(); // отправляем запрос, результат придёт в обработчик onreadystatechange

// установка обработчика событий
xhr.onreadystatechange = function() {
    // if (xhr.readyState==4 && xhr.status==200) {
    // 	console.log(xhr.responseText);
    // }

    if (xhr.readyState != 4) return;

    if (xhr.status != 200) {
        // обработать ошибку
        console.log(xhr.status + ':' + xhr.statusText);
        return;
    } 
    
    // получить результат из this.responseText или this.responseXML
    console.log(xhr.responseText);
}
</code></pre>

<!------------------------------------------------------>
<h3>Синхронный</h3>
<!------------------------------------------------------>
<ul class="list-point">
	<li>Возможность делать запросы на другой домен и указывать таймаут, в синхронном режиме не работают</li>
</ul>
<pre><code class="js">
var xhr = new XMLHttpRequest();       // создаём новый объект XMLHttpRequest
xhr.open('GET', 'script.php', false); // конфигурируем его: GET-запрос на URL 'script.php'
xhr.send();                           // отсылаем запрос

// если код ответа сервера не 200, то это ошибка
if (xhr.status != 200) {
	// обработать ошибку (пример вывода: 404: Not Found)
    console.log(xhr.status + ':' + xhr.statusText);
} else {
	// вывести результат (responseText -- текст ответа)
    console.log(xhr.responseText);
} 
</code></pre>
