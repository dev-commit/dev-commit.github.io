<h2>Cookie</h2>

<u-link-wrapper>
	<a href="https://learn.javascript.ru/cookie" target="_blank">Learn Javascript</a>
</u-link-wrapper>

<ul class="list-point">
    <li><u-text-define>Cookie</u-text-define> - небольшой объем именованных данных (в текстовом виде), отправленный веб-сервером и хранимый в браузере пользователя</li>
	<li>Данные cookie автоматически передаются между веб-браузером и веб-сервером в составе HTTP-запроса, так что серверные сценарии могут читать и записывать значения cookie, сохраняемые на стороне клиента.</li>
</ul>

<img src="/@img/js/client-storage/cookie.jpg">

<!------------------------------------------------------------->
<h4>Применение</h4>
<!------------------------------------------------------------->
<ul class="list-point">
    <li>Аутентификация пользователя</li>
    <li>Хранение персональных предпочтений и настроек пользователя</li>
    <li>Отслеживание состояния сеанса доступа пользователя</li>
    <li>Сведения статистики о пользователях</li>
</ul>

<!------------------------------------------------------------->
<h4>Особенности</h4>
<!------------------------------------------------------------->
<ul class="list-point">
	<li>Данные отправляются обратно на сервер для каждого HTTP-запроса</li>
	<li>Работают только на веб-сервере</li>
</ul>

<!------------------------------------------------------------->
<h4>Ограничения</h4>
<!------------------------------------------------------------->
<ul class="list-point">
    <li>Не больше 300 Cookie для сайта. При превышении лимита самые старые файлы перезаписываются</li>
    <li>Размер одной Cookie не больше 4КБ. При превышении, самые старые байты перезаписываются</li>
    <li>От одного домена (второго уровня, включая поддомены) может быть установлено не более 20 Cookie</li>
    <li>Для конкретного сайта будут доступны только те Cookie, которые им были установлены</li>
</ul>

<!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
<h3>Типы куки</h3>
<!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
<ol class="list-num">
	<li><u-text-underline>Сессионные куки</u-text-underline> (временные) - существуют только во временной памяти, пока пользователь находится на странице веб-сайта. Браузеры обычно удаляют сессионные куки после того, как пользователь закрывает окно браузера. В отличие от других типов куки, сессионные куки не имеют истечения срока действия</li>
	<li><u-text-underline>Постоянные куки</u-text-underline> - удаляются в определённую дату или через определённый промежуток времени. Это означает, что информация о куки будет передаваться на сервер каждый раз, когда пользователь посещает веб-сайт, которому эти куки принадлежат</li>
	<li><u-text-underline>Защищенные куки</u-text-underline> - могут быть переданы только через шифрованное соединение (HTTPS). Они не могут передаваться по незащищенным соединениям. Чтобы защитить куки, необходимо добавить флаг <u-code-light>secure</u-code-light> в файл куки</li>
	<li><u-text-underline>HttpOnly-куки</u-text-underline> - нельзя обращаться с помощью API на стороне клиента, таких как JS</li>
</ol>
`
<!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
<h3>Атрибуты cookie</h3>
<!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
<v-code lang="js none" title="">
document.cookie = `
	info=123;
	expires=Fri, 31 Dec 2018 23:59:59 GMT;
	path=/;
	domain=.example.org
`;
</v-code>

<ul class="list-point">
	<b>Обязательные</b>
	<li><u-code-text>name</u-code-text> - имя</li>
	<li><u-code-text>value</u-code-text> - значение</li>
	<hr>
	
	<b>Время жизни</b>
	<li><u-code-text>expires</u-code-text> - по умолчанию cookies являются временными (сеансовыми) - их значения сохраняются на период сеанса браузера и теряются при закрытии сеанса пользователем. Чтобы cookie сохранялся после окончания сеанса, необходимо сообщить браузеру, как долго он должен храниться. Атрибут <u>expires</u> указывает дату окончания действия cookie. Значение expires (RFC 2616) записывается в формате <u>"Wdy, DD Mon YYYY HH:MM:SS GMT"</u>. Если этот атрибут не задан, то cookie хранится в течение одного сеанса, до закрытия браузера.</li>

	<li><u-code-text>max age</u-code-text> - аналогичен атрибуту <u>expires</u>, но срок хранения определяется в секундах (RFC 6265). Значение десятичное неотрицательное целое число. По истечении заданного времени клиент должен отказаться от куки. Значение "0" означает, что от cookie нужно отказаться немедленно.</li>

	<li>Установка значения любого из этих атрибутов(expires, max age) заставляет браузер сохранить cookie в локальном файле, чтобы он мог быть прочитан при следующем посещении пользователем веб страницы. После того как будет достигнута дата окончания действия expires или истечет период max age, браузер автоматически удалит cookie файл.</li>
	<hr>

	<b>Видимость и безопасность</b>
	<li><u-code-text>path</u-code-text> - задает веб-страницы, с которыми связан cookie. По умолчанию cookie связывается с создавшей его веб страницей и доступен этой же странице, а также любой другой странице из того же каталога или любых его подкаталогов.</li>

<v-code lang="bash none" title="">
› http://www.example.com/catalog/index          # Страница, создавшая cookie
› http://www.example.com/catalog/order          # Cookie виден
› http://www.example.com/catalog/widgets/index  # Cookie виден
› http://www.example.com/about                  # Cookie НЕ виден
</v-code>

	<li>Этого правила видимости, принятого по умолчанию, обычно вполне достаточно. Тем не менее иногда значения cookie файла требуется использовать на всем многостраничном веб сайте независимо от того, какая страница создала cookie. Чтобы это можно было сделать, для cookie файла задается значение <u>path(path=/;)</u>. Тогда любая страница того же веб сервера, содержащая указанное значение в своем URL, сможет использовать cookie файл.</li>

	<li><u-code-text>domain</u-code-text> - по умолчанию cookies доступны только страницам, загружаемым с того веб-сервера, который их установил. Однако, большим веб-сайтам может потребоваться возможность совместного использования cookies несколькими веб серверами. Если атрибут domain для cookie не установлен, значением по умолчанию будет имя веб сервера, на котором находится страница. НЕЛЬЗЯ сделать так, чтобы домен cookie файла отличался от домена вашего сервера.</li>
	<li><u-code-text>secure</u-code-text> - логический атрибут, определяющий, как значения cookie файла передаются по сети. По умолчанию cookie не защищен, т.е. передается по обычному незащищенному HTTP соединению. Однако если cookie помечен как защищенный, он передается, только когда обмен между браузером и сервером организован по протоколу HTTPS или другому защищенному протоколу. По умолчанию принимает значение false.</li>
</ul>

<!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
<h3>Установка cookie через JavaScript</h3>
<!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
<v-code lang="js" title="">
// установить cookie (удаляются при закрытии браузера)
document.<u-code>cookie</u-code> = 'info=123';

// установить cookie (удалятся 31.12.2000)
document.<u-code>cookie</u-code> = 'info=123; expires=Fri, 31 Dec 2000 23:59:59 GMT';

// прочитать cookie
const cookie = document.<u-code>cookie</u-code>;
</v-code>


<!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
<h3>Дополнительно</h3>
<!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
<!------------------------------------------------------------->
<h4>Сторонние cookie</h4>
<!------------------------------------------------------------->
<ul class="list-point">
	<li>Хотя cookies отправляются только на серверы домена, для которого они предназначены, веб-страница может подгружать изображения или другие компоненты из других доменов. Cookies, получаемые во время загрузки этих компонентов из других доменов, называются "сторонними".</li>
	<li>Рекламные компании используют сторонние куки для отслеживания перемещений пользователя по сайтам. В частности, рекламная компания может отслеживать пользователей на всех сайтах, где установлены их рекламные баннеры. Знание страниц, посещённых пользователем, позволяет менять направленность рекламы в зависимости от предпочтений пользователя.</li>
</ul>

<!------------------------------------------------------------->
<h4>Приватность</h4>
<!------------------------------------------------------------->
<ul class="list-point">
	<li>Создание профиля пользователей рассматривается как потенциальная угроза приватности даже при отслеживании в рамках одного домена, но особенно это актуально при отслеживания на нескольких доменах с использованием сторонних куки. По этой причине в некоторых странах cookies регулируются законодательством.</li>
	<li>Спецификация P3P включает возможность для веб-сервера сообщить браузеру о нарушении конфиденциальности, указывая характер собираемой информации и цели сбора. Сюда входит и использование информации, полученной с помощью куки. По спецификации P3P браузер может принимать или отклонять куки согласно пользовательским настройкам или же спросить пользователя.</li>
</ul>

<!------------------------------------------------------------->
<h4>Рекомендации по созданию cookies-файлов</h4>
<!------------------------------------------------------------->
<ul class="list-point">
	<li>Пользователь при помощи JavaScript может изменить cookies-файлы. Более того, существует возможность заменить сессионные куки постоянными. Серверное программное обеспечение должно отслеживать такие попытки. Для этого сервер выдаёт куки на определённый срок и записывает дату окончания куки у себя каждый раз, когда пользователь обращается к серверу. Если куки, присланный браузером, имеет дату действия отличную от той, что хранится на сервере, значит имеет место попытка подмены даты действия куки. Сервер может отреагировать, например, запросив у пользователя повторную авторизацию. Или изначально установить флаг <u-code-light>HttpOnly</u-code-light> в заголовке Методы и структура протокола HTTP Set-Cookie, который делает cookies недоступными для скриптов со стороны клиента.</li>
	<li>На сервере обычно хранят время последней активности пользователя. И время действия куки зависит от типа ресурса, например на форумах от 3 дней, до месяца, на админских панелях 1 день.</li>
	<li>При начале новой сессии ID (уникальную строку) в файле куки нужно менять каждый раз. Это нужно для безопасности, чтобы другой человек похитив эту ID- строку не мог пользоваться аккаунтом жертвы постоянно. Также строку нужно менять при каждом вводе пользователем логина и пароля.</li>
</ul>
