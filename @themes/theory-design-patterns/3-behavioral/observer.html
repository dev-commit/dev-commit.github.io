<!-- TODO:
<f-search>Паттерны -> Observer (Наблюдатель)</f-search>
-->

<h2>Observer (Наблюдатель)</h2>

<ul class="list-point">
    <li><u-text-define>Observer</u-text-define> - создаёт механизм подписки, позволяющий одним объектам отслеживать и реагировать на события, происходящие в других объектах</li>
    <hr>
    <li>Основан на зависимости один ко многим: при изменении состояния объекта Observable, все зависимые объекты Observer оповещаются об этом</li>
    <li><u>Observable</u> - наблюдаемый объект. Содержит список [Observer] и при изменении <u>state</u>, проходит в цикле по всем Observer и оповещает их</li>
    <li><u>[Observer]</u> (Подписчики) - наблюдатели за Observable</li>
</ul>

<!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
<h3>Реализация</h3>
<!-- xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx -->
<ul class="list-point">
    <li><u-code>state</u-code> - свойство, от изменения которого зависит состояние других объектов</li>
    <li><u-code>subscribers</u-code> - список зависящих от <u>state</u> объектов</li>

    <li><u-code-text>subscribe()</u-code-text> - подписка на изменения <u>state</u></li>
    <li><u-code-text>unsubscribe()</u-code-text> - отписка от изменений <u>state</u></li>
    <li><u-code-text>getState()</u-code-text> - метод для получения <u>state</u></li>
    <li><u-code-text>setState()</u-code-text> - метод для изменения <u>state</u></li>
    <li><u-code-text>notify()</u-code-text> - метод для оповещения подписчиков об изменении <u>state</u></li>

</ul>

<!------------------------------------------------------------->
<h4>Основная реализация</h4>
<!------------------------------------------------------------->
<v-two-code type="js border;js border" comment="Класс;Функция">
<template v-slot:first>
class Observable {
  constructor() {
    this.state = 'Initial Data'
    this.subscribers = []
  }
  subscribe(subscriber) {
    this.subscribers.push(subscriber)
  }
  unsubscribe(subscriber) {
    this.subscribers = this.subscribers.filter(el => el !== subscriber)
  }
  getState() {
    return this.state
  }
  setState(data) {
    this.state = data
    this.notify()
  }
  notify() {
    this.subscribers.forEach(subscriber => subscriber.update(this.state))
  }
}

class Subscriber {
  update(data) {
    console.log('Subscriber Udated Data', data)
  }
}

// Использование
const observable = new Observable()
const subscriber = new Subscriber()

observable.subscribe(subscriber)
// observable.unsubscribe(subscriber)
observable.setState('New Data')

const state = observable.getState()
console.log('Observable State', state)
</template>
<template v-slot:last>
// Фабрика для Observable
const createObservable = () => {
  let state = 'Initial Data'
  const subscribers = []

  return {
    subscribe(subscriber) {
      subscribers.push(subscriber)
    },
    unsubscribe(subscriber) {
      subscribers = subscribers.filter(el => el !== subscriber)
    },
    getState() {
      return state
    }
    setState(data) {
      state = data
      this.notify()
    },
    notify() {
	    subscribers.forEach(subscriber => subscriber.update(state))
    },
  }
}

// Фабрика для Subscriber
const createSubscriber = () => {
  return {
    update(data) {
      console.log('Subscriber Udated Data', data)
    }
  };
}

// Использование
const observable = createObservable()
const subscriber = createSubscriber()

observable.subscribe(subscriber)
// observable.unsubscribe(subscriber)
observable.setState('New Data')

const state = observable.getState()
console.log('Observable State', state)
</template>
</v-two-code>

<!------------------------------------------------------------->
<h4>Релизация с action.type</h4>
<!------------------------------------------------------------->
<v-code lang="js" title="">
class Observable {
  constructor() {
    this.subscribers = [];
  }
  subscribe(subscriber) {
    this.subscribers.push(subscriber);
  }
  unsubscribe(subscriber) {
    this.subscribers = this.subscribers.filter(el => el !== subscriber);
  }
  notify(action) {
    this.subscribers.forEach(el => el.update(action));
  }
}

class Subscriber {
  constructor(state = 1) {
    this.state = state;
    this.initialState = state;
  }

  update(action) {
    switch (action.type) {
      case 'INCREMENT': this.state = ++this.state;    break;
      case 'DECREMENT': this.state = --this.state;    break;
      case 'ADD':       this.state += action.payload; break;
      default:          this.state = this.initialState;
    }
  }
}

const observable = new Observable();
const subscriber = new Subscriber();

observable.subscribe(subscriber);

observable.notify({ type: 'INCREMENT' }); // => 2
observable.notify({ type: 'DECREMENT' }); // => 0
observable.notify({ type: 'ADD', payload: 10 }); // => 11

console.log(subscriber.state);
</v-code>
